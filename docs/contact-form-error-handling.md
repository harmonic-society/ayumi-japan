# お問い合わせフォーム - エラー表示ロジック仕様書

## 概要
このドキュメントでは、Ayumi Japan WordPressテーマにおけるお問い合わせフォームのエラー表示ロジックを説明します。フォームはContact Form 7プラグインを使用しており、カスタムCSSでスタイリングされています。

## 関連ファイル
- **テンプレートファイル**: `/template-contact.php`
- **プラグイン**: Contact Form 7
- **実装場所**: 行35-50（HTML）、行163-268（CSS）

---

## 1. フォームの状態管理

### 1.1 プラグイン有無チェック
```php
if ( function_exists( 'wpcf7_contact_form' ) ) {
    // Contact Form 7が有効な場合 → フォーム表示
    echo do_shortcode( '[contact-form-7 id="contact" title="お問い合わせフォーム"]' );
} else {
    // Contact Form 7が無効な場合 → 警告表示
    // .notice-box で警告メッセージを表示
}
```

**表示される警告ボックス** (`.notice-box`):
- 背景色: `#fff3cd` (黄色)
- ボーダー: `2px solid #ffc107` (濃い黄色)
- テキスト色: `#856404` (茶色)
- 内容: プラグインのインストールを促すメッセージ

---

## 2. バリデーションエラー（個別フィールド）

### 2.1 フィールド単位のエラー表示
Contact Form 7が自動的に生成する `.wpcf7-not-valid-tip` クラスでエラーメッセージを表示します。

**CSSスタイル** (行227-230):
```css
.wpcf7-form .wpcf7-not-valid-tip {
    color: #d9534f;           /* 赤色テキスト */
    font-size: 0.9em;         /* やや小さめ */
    margin-top: 5px;          /* フィールドの下に配置 */
}
```

**表示タイミング**:
- フォーム送信時に必須フィールドが未入力の場合
- メールアドレスの形式が不正な場合
- 電話番号の形式が不正な場合（設定されている場合）

**表示位置**:
- エラーのあるフィールドの直下に表示
- フィールドごとに個別のエラーメッセージ

---

## 3. フォーム全体のエラー（検証エラー）

### 3.1 検証エラーメッセージ
複数のフィールドにエラーがある場合、フォーム全体のエラーメッセージが表示されます。

**CSSスタイル** (行232-240):
```css
.wpcf7-response-output {
    margin: 25px 0 0;         /* フォームの下に配置 */
    padding: 15px 20px;
    border-radius: 10px;
    text-align: center;       /* 中央揃え */
}

.wpcf7-validation-errors {
    border: 2px solid #d9534f;      /* 赤いボーダー */
    background-color: #f8d7da;      /* 薄い赤背景 */
    color: #721c24;                 /* 濃い赤テキスト */
}
```

**表示内容**:
- デフォルト: 「1つ以上の項目でエラーが見つかりました。ご確認ください。」
- カスタマイズ可能: Contact Form 7の設定画面で編集可能

**表示タイミング**:
- フォーム送信ボタンをクリック時
- バリデーションに失敗した場合

---

## 4. 送信成功メッセージ

### 4.1 成功時の表示
フォームが正常に送信された場合の表示。

**CSSスタイル** (行242-246):
```css
.wpcf7-mail-sent-ok {
    border: 2px solid var(--success-color);  /* 緑のボーダー (#9CAF88) */
    background-color: #d4edda;               /* 薄い緑背景 */
    color: #155724;                          /* 濃い緑テキスト */
}
```

**表示内容**:
- デフォルト: 「メッセージは正常に送信されました。」
- カスタマイズ可能: Contact Form 7の設定画面で編集可能

**表示タイミング**:
- フォーム送信が正常に完了した場合
- メール送信が成功した場合

---

## 5. フィールドのフォーカス状態

### 5.1 入力中の視覚フィードバック
ユーザーがフィールドに入力している際の視覚的なフィードバック。

**CSSスタイル** (行194-199):
```css
.wpcf7-form input:focus,
.wpcf7-form textarea:focus {
    outline: none;
    border-color: var(--primary-color);              /* ゴールドのボーダー (#D4AF87) */
    box-shadow: 0 0 0 3px rgba(212, 175, 135, 0.15); /* 薄いゴールドの影 */
}
```

**動作**:
- フィールドをクリックまたはタブでフォーカスした際に適用
- トランジション: `all 0.3s ease` でスムーズなアニメーション

---

## 6. エラー表示の優先順位

エラーは以下の順序で表示されます:

1. **個別フィールドエラー** (`.wpcf7-not-valid-tip`)
   - 各フィールドの直下に表示
   - 赤色テキストで即座に確認可能

2. **フォーム全体のエラー** (`.wpcf7-validation-errors`)
   - フォームの最下部（送信ボタンの下）に表示
   - 赤い背景ボックスで目立つ

3. **成功メッセージ** (`.wpcf7-mail-sent-ok`)
   - エラーがない場合のみ表示
   - 緑色の背景ボックス

---

## 7. レスポンシブ対応

### 7.1 モバイル表示の調整
768px以下の画面幅でのスタイル変更。

**モバイル用CSS** (行405-407):
```css
@media (max-width: 768px) {
    .wpcf7-form .wpcf7-submit {
        width: 100%;          /* 送信ボタンを全幅に */
        padding: 14px 30px;   /* パディング調整 */
    }
}
```

**影響**:
- エラーメッセージの表示位置は変わらない
- 送信ボタンが全幅になることで、タップしやすくなる

---

## 8. カラースキーム

### 8.1 使用されている色

| 状態 | 要素 | 色コード | 説明 |
|------|------|----------|------|
| エラー（テキスト） | `.wpcf7-not-valid-tip` | `#d9534f` | 赤色 |
| エラー（ボーダー） | `.wpcf7-validation-errors` | `#d9534f` | 赤色 |
| エラー（背景） | `.wpcf7-validation-errors` | `#f8d7da` | 薄い赤 |
| エラー（テキスト本文） | `.wpcf7-validation-errors` | `#721c24` | 濃い赤 |
| 成功（ボーダー） | `.wpcf7-mail-sent-ok` | `#9CAF88` | 緑色 |
| 成功（背景） | `.wpcf7-mail-sent-ok` | `#d4edda` | 薄い緑 |
| 成功（テキスト） | `.wpcf7-mail-sent-ok` | `#155724` | 濃い緑 |
| フォーカス（ボーダー） | `input:focus, textarea:focus` | `#D4AF87` | ゴールド |
| フォーカス（影） | `input:focus, textarea:focus` | `rgba(212,175,135,0.15)` | 薄いゴールド |

---

## 9. JavaScriptによる動的処理

Contact Form 7はJavaScriptを使用してAJAX送信を行います。

### 9.1 動作フロー

1. **フォーム送信**
   - ユーザーが送信ボタンをクリック
   - JavaScriptがフォームデータを取得

2. **クライアント側バリデーション**
   - 必須フィールドのチェック
   - メール形式のチェック
   - エラーがあれば `.wpcf7-not-valid-tip` を各フィールドに追加

3. **AJAX送信**
   - バリデーション通過後、サーバーにデータ送信
   - ページリロードなしで結果を表示

4. **結果表示**
   - 成功: `.wpcf7-mail-sent-ok` クラスを持つメッセージ表示
   - 失敗: `.wpcf7-validation-errors` クラスを持つメッセージ表示

---

## 10. カスタマイズポイント

### 10.1 エラーメッセージのカスタマイズ

**方法1: Contact Form 7管理画面**
- WordPress管理画面 > お問い合わせ > コンタクトフォーム
- 「メッセージ」タブでテキストを編集

**方法2: CSSでスタイル変更**
- `template-contact.php` のCSSセクション（行227-246）を編集
- 色、サイズ、配置などを調整可能

**方法3: JavaScriptでカスタム処理追加**
- Contact Form 7のフックを使用
- `wpcf7mailsent`, `wpcf7invalid`, `wpcf7spam` などのイベント

---

## 11. アクセシビリティ対応

### 11.1 現在の実装

✅ **実装済み**:
- エラーメッセージの色コントラスト（WCAG AA準拠）
- フォーカス時の視覚的フィードバック
- キーボードナビゲーション対応（デフォルト）

⚠️ **改善可能**:
- エラー発生時のスクリーンリーダー対応（Contact Form 7デフォルトに依存）
- エラーフィールドへの自動フォーカス（オプション）

---

## 12. トラブルシューティング

### 12.1 よくある問題と解決方法

**問題1: エラーメッセージが表示されない**
- 原因: Contact Form 7が未インストール/無効化
- 解決: プラグインをインストール・有効化

**問題2: 送信ボタンを押してもエラーも成功も表示されない**
- 原因: JavaScriptエラー、他プラグインとの競合
- 解決: ブラウザコンソールでエラー確認、プラグインを一時無効化してテスト

**問題3: エラーメッセージのスタイルが反映されない**
- 原因: CSS優先順位の問題
- 解決: `!important` を追加、またはより具体的なセレクタを使用

**問題4: モバイルでエラーメッセージが見づらい**
- 原因: レスポンシブCSSの不足
- 解決: `@media` クエリでフォントサイズ、パディング調整

---

## 13. 今後の拡張案

### 13.1 機能追加の候補

1. **リアルタイムバリデーション**
   - フィールドから離れた瞬間にバリデーション実行
   - JavaScriptカスタマイズが必要

2. **カスタムエラーアイコン**
   - Font Awesomeなどのアイコンを追加
   - 視認性向上

3. **アニメーション強化**
   - エラー表示時にスライドイン/フェードイン
   - CSS transitionまたはJavaScript

4. **エラー履歴の保存**
   - よくあるエラーをログとして保存
   - 管理画面で確認可能に

---

## 更新履歴

| 日付 | バージョン | 変更内容 |
|------|-----------|---------|
| 2025-01-XX | 1.0 | 初版作成 |

---

## 参考リンク

- [Contact Form 7 公式ドキュメント](https://contactform7.com/docs/)
- [WordPress テーマ開発](https://developer.wordpress.org/themes/)
- [WCAG 2.1 アクセシビリティガイドライン](https://www.w3.org/WAI/WCAG21/quickref/)
